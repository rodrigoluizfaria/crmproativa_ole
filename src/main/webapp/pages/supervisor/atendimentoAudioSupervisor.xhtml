<ui:fragment xmlns="http://www.w3.org/1999/xhtml"
             xmlns:h="http://java.sun.com/jsf/html"
             xmlns:f="http://java.sun.com/jsf/core"
             xmlns:o="http://omnifaces.org/ui"
             xmlns:pe="http://primefaces.org/ui/extensions"
             xmlns:ui="http://java.sun.com/jsf/facelets"
             xmlns:p="http://primefaces.org/ui">

    <!-- DLG MODAL -->
    <p:dialog id="dlgAudio" widgetVar="dlgAudio" modal="true" draggable="false" resizable="false" closable="false"
              visible="false" width="70%" styleClass="dialog-formulario" responsive="true"
              header="ÁUDIOS ATENDIMENTO:  #{supervisorBackofficeBean.clienteAudio}" appendTo="@(body)">

        <h:panelGroup
                rendered="#{(supervisorBackofficeBean.listAudiosAtendimentos eq null or empty supervisorBackofficeBean.listAudiosAtendimentos) and (supervisorBackofficeBean.listConciliar eq null or empty supervisorBackofficeBean.listConciliar) }">

            <div class="col-12  ">

                <div class="ui-fluid">

                    <div class="card col-12 ">

                        <p:outputLabel value="Nenhum áudio Disponivel...."/>

                    </div>

                </div>
            </div>


        </h:panelGroup>

        <h:form id="formAudio" prependId="false">


            <h:panelGroup styleClass="col-12 "
                          rendered="#{supervisorBackofficeBean.listAudiosAtendimentos ne null and not empty supervisorBackofficeBean.listAudiosAtendimentos}"
                          layout="block">

                <div class="ui-g ui-fluid card">

                    <p:dataTable id="tableAtendimentos" var="atendimento" rows="5" paginator="true"
                                 paginatorPosition="bottom" value="#{supervisorBackofficeBean.listAudiosAtendimentos}"
                                 emptyMessage="#{supervisorBackofficeBean.listAudiosAtendimentos eq null? '' : msg.emptyMessage}"
                                 currentPageReportTemplate="[#{msg.totalDeRegistros}: {totalRecords}]"
                                 paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {Exporters}"
                                 styleClass="ui-datatable-striped">

                        <p:ajax event="page"/>

                        <p:ajax event="sort" global="false"/>

                        <p:column headerText="Data" sortBy="#{atendimento.data}" width="20%">

                            <h:outputLabel value="#{atendimento.data}">

                                <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss"/>

                            </h:outputLabel>

                        </p:column>

                        <p:column headerText="Ramal" sortBy="#{atendimento.ramal}" width="10%">

                            <h:outputLabel value="#{atendimento.ramal}">


                            </h:outputLabel>

                        </p:column>

                        <p:column headerText="Destino" sortBy="#{atendimento.destino}" width="20%">

                            <h:outputLabel value="#{atendimento.destino}">


                            </h:outputLabel>

                        </p:column>

                        <p:column headerText="Fila" sortBy="#{atendimento.fila}" width="20%">

                            <h:outputLabel value="#{atendimento.fila}">


                            </h:outputLabel>

                        </p:column>


                        <p:column headerText="Tipo" sortBy="#{atendimento.descricao}" width="20%">

                            <h:outputLabel value="#{atendimento.tipoIntegracao.constante}">


                            </h:outputLabel>

                        </p:column>

                        <p:column headerText="Audio" sortBy="#{atendimento.descricao}" width="45%">

                            <h:panelGroup rendered="#{atendimento.tipoIntegracao eq 'VONIX'}">

                                <a href="http://#{atendimento.pabx.url}/recordings/#{atendimento.descricao}"
                                   title="Baixar audio.">

                                    <i class="fa fa-volume-up fa-lg">

                                    </i>

                                </a>

                            </h:panelGroup>

                            <h:panelGroup rendered="#{atendimento.tipoIntegracao eq 'TRES_CPLUS' and not empty atendimento.urlAudio}"
                                    style="display: flex;align-items: center">


                                <p:audio value="#{atendimento.urlAudio}" styleClass="mr-3"
                                         player="mp3"
                                         controls="true"
                                         onplay="console.log('MP3 Started Playing')"
                                         onpause="console.log('MP3 Stopped Playing')">
                                    Your browser does not support the audio element.
                                    See: <h:outputLink
                                        value="https://www.w3schools.com/html/html5_audio.asp">HTML5 Audio</h:outputLink>
                                </p:audio>

                                <div>

                                    <p:commandButton icon="fa  fa-file-text-o" onclick="PF('sidebar2').show()"
                                                     styleClass="ui-button-flat ui-button-secondary"
                                                     update="pnpSidebar" process="@this"
                                                     actionListener="#{supervisorBackofficeBean.onFindCallid(atendimento.descricao)}"/>
                                </div>

                                <p:sidebar widgetVar="sidebar2" id="sidebar2" position="right"
                                           style="width: 660px !important;overflow: scroll;">

                                    <h:panelGroup id="pnpSidebar">

                                        <div class="p-4 pb-6 border-bottom-1 border-200 text-center">
                                            <h3 class="text-center  font-bold">Informação da ligação.</h3>
                                            <span class="text-600 text-center text-xl "> Informações do discador</span>
                                        </div>

                                        <div class="grid">

                                            <div class="col-12" style="padding: 10px">

                                                <div class="ui-fluid formgrid grid p-3">

                                                    <div class="field col-12 md:col-3">

                                                        <p:outputLabel value="Agente" styleClass="font-semibold"/>

                                                        <div>

                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.agent}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>

                                                    <div class="field col-12 md:col-3">

                                                        <p:outputLabel value="Número" styleClass="font-semibold"/>

                                                        <div>

                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.numberPtBr}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>

                                                    <div class="field col-12 md:col-3">

                                                        <p:outputLabel value="Data" styleClass="font-semibold"/>

                                                        <div>

                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.call_date}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>

                                                    <div class="field col-12 md:col-3">

                                                        <p:outputLabel value="Qualificação" styleClass="font-semibold"/>

                                                        <div>

                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.qualification}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>

                                                    <div class="field col-12 md:col-6 mt-3">

                                                        <p:outputLabel value="Comportamento"
                                                                       styleClass="font-semibold"/>

                                                        <div>

                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.readable_behavior_text}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>


                                                    <div class="field col-12 md:col-6 mt-3">

                                                        <p:outputLabel value="Ligação" styleClass="font-semibold"/>

                                                        <div>
                                                            <p:audio
                                                                    value="#{supervisorBackofficeBean.callTresC.data.recording}"
                                                                    style="width: 100%"
                                                                    player="mp3"
                                                                    controls="true"
                                                                    onplay="console.log('MP3 Started Playing')"
                                                                    onpause="console.log('MP3 Stopped Playing')">
                                                                Your browser does not support the audio element.
                                                                See: <h:outputLink
                                                                    value="https://www.w3schools.com/html/html5_audio.asp">HTML5 Audio</h:outputLink>
                                                            </p:audio>

                                                        </div>

                                                    </div>

                                                </div>

                                            </div>

                                        </div>

                                        <h4 class="mt-3 pl-3 font-bold">Dados da ligação</h4>

                                        <div class="grid">

                                            <div class="col-12" style="padding: 10px">

                                                <div class="ui-fluid formgrid grid p-3">

                                                    <div class="field col-12 p-2 ">

                                                        <p:outputLabel value="Campanha" styleClass="font-semibold"/>

                                                        <div>
                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.campaign}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>
                                                    <div class="field col-12 p-2 ">

                                                        <p:outputLabel value="Lista do mailing"
                                                                       styleClass="font-semibold"/>

                                                        <div>
                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.list}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>

                                                    <div class="field col-6 ">

                                                        <p:outputLabel value="Modo ligação" styleClass="font-semibold"/>

                                                        <div>

                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.mode}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>

                                                    <div class="field col-6 ">

                                                        <p:outputLabel value="Status" styleClass="font-semibold"/>

                                                        <div>

                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.readable_status_text}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>
                                                    <div class="field col-6 ">

                                                        <p:outputLabel value="Tipo" styleClass="font-semibold"/>

                                                        <div>

                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.phone_type}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>

                                                    <div class="field col-6 ">

                                                        <p:outputLabel value="Tempo de conversação"
                                                                       styleClass="font-semibold"/>

                                                        <div>

                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.speaking_time}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>

                                                    <div class="field col-6 ">

                                                        <p:outputLabel value="Tempo de pós atendimento"
                                                                       styleClass="font-semibold"/>

                                                        <div>

                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.acw_time}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>

                                                    <div class="field col-6 ">

                                                        <p:outputLabel value="Causa do desligamento"
                                                                       styleClass="font-semibold"/>

                                                        <div>

                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.readable_hangup_cause_text}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>
                                                    <div class="field col-6 ">

                                                        <p:outputLabel value="Detecção de caixa postal"
                                                                       styleClass="font-semibold"/>

                                                        <div>

                                                            <h:outputText
                                                                    value="#{supervisorBackofficeBean.callTresC.data.readable_amd_status_text}"
                                                                    style="resize: none;"/>

                                                        </div>

                                                    </div>

                                                </div>

                                            </div>

                                        </div>

                                        <h:panelGroup id="pnpMailing"
                                                      rendered="#{not empty supervisorBackofficeBean.callTresC.data.mailing_data.dataToMap}">


                                            <h4 class="mt-3 pl-3 font-bold">Dados do mailing.</h4>

                                            <div class="grid">

                                                <div class="col-12" style="padding: 10px">

                                                    <div class="ui-fluid formgrid grid p-3">


                                                        <ui:repeat
                                                                value="#{supervisorBackofficeBean.callTresC.data.mailing_data.dataToMap.keySet()}"
                                                                var="entry">

                                                            <div class="field col-12 pb-3 ">

                                                                <p:outputLabel value="#{entry}"
                                                                               styleClass="font-semibold"/>

                                                                <div>

                                                                    <h:outputText
                                                                            value="#{supervisorBackofficeBean.callTresC.data.mailing_data.dataToMap.get(entry)}"
                                                                            style="resize: none;"/>

                                                                </div>

                                                            </div>

                                                        </ui:repeat>
                                                    </div>
                                                </div>
                                            </div>

                                        </h:panelGroup>

                                    </h:panelGroup>

                                </p:sidebar>


                            </h:panelGroup>


                            <h:panelGroup rendered="#{atendimento.tipoIntegracao eq 'VSPHONE'}">

                                <p:commandLink update="dlgBase" styleClass="ui-button-flat"
                                               actionListener="#{supervisorBackofficeBean.onPlayModal(atendimento)}"
                                               value="Baixar audio.">
                                    <i class="fa fa-volume-up fa-lg"/>
                                </p:commandLink>

                            </h:panelGroup>

                            <h:panelGroup rendered="#{atendimento.tipoIntegracao eq 'PST_PHONE'}">

                                <audio controls="controls" preload="none" style="width: 100%; height: 35px; border-radius: 20px; background-color: #f1f5f9;">
                                    <source src="#{atendimento.urlPublicaRange}" type="audio/mpeg"/>
                                </audio>

                            </h:panelGroup>

                        </p:column>

                    </p:dataTable>
                </div>

            </h:panelGroup>

            <h:panelGroup styleClass="col-12 "
                          rendered="#{supervisorBackofficeBean.listConciliar ne null and not empty supervisorBackofficeBean.listConciliar}"
                          layout="block">

                <div class="ui-g ui-fluid card">

                    <h4>Áudios Anexados</h4>

                    <p:dataTable id="tableConciliar" var="audioAnexo" rows="5" paginator="true"
                                 paginatorPosition="bottom" value="#{supervisorBackofficeBean.listConciliar}"
                                 emptyMessage="#{supervisorBackofficeBean.listConciliar eq null? '' : msg.emptyMessage}"
                                 currentPageReportTemplate="[#{msg.totalDeRegistros}: {totalRecords}]"
                                 paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {Exporters}"
                                 styleClass="ui-datatable-striped">

                        <p:ajax event="page"/>

                        <p:ajax event="sort" global="false"/>

                        <p:column headerText="Data Anexo" sortBy="#{audioAnexo.dataAnexo}" width="10%">

                            <h:outputLabel value="#{audioAnexo.dataAnexo}">

                                <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss"/>

                            </h:outputLabel>


                        </p:column>

                        <p:column headerText="Arquivo" sortBy="#{audioAnexo.nomeArquivo}" width="70%">


                            <h:outputLabel value="#{audioAnexo.nomeArquivo}"
                                           title="Nome original: #{audioAnexo.nomeArquivoOriginal}">

                                <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss"/>

                            </h:outputLabel>

                        </p:column>

                        <p:column headerText="Tamanho" sortBy="#{audioAnexo.nomeArquivo}" width="10%">

                            <h:outputLabel value="#{audioAnexo.tamanhoArquivo / 1000} KB">

                                <f:convertNumber pattern="#0.000"/>

                            </h:outputLabel>

                        </p:column>


                        <p:column headerText="Audio" width="10%">

                            <p:commandLink styleClass="rounded-button ui-button-flat" update="msgAudio"
                                           onstart="PF('blockUIWidget2').block()"
                                           oncomplete="PF('blockUIWidgetAnexo').unblock()" title="baixar" ajax="false"
                                           actionListener="#{supervisorBackofficeBean.baixarArquivoWav(audioAnexo)}">

                                <i class="pi pi-download"/>

                                <p:fileDownload value="#{supervisorBackofficeBean.fileWav}"/>

                            </p:commandLink>


                        </p:column>

                    </p:dataTable>

                    <pe:blockUI target="tableAtendimentos" content="blockUIContentPanel"
                                widgetVar="blockUIWidgetAnexo"/>
                    <p:messages id="msgAudio"/>

                </div>

                <h:panelGrid id="blockUIContentPanel" columns="2"
                             style="display:none;table-layout:auto;background-color:#fff">

                    <i class="pi pi-spin pi-spinner" style="font-size: 3rem"></i>

                    <h:outputText value="Aguarde, processando....." style="white-space: nowrap;"/>

                </h:panelGrid>

            </h:panelGroup>

        </h:form>

        <div class="mt-4" style="text-align: center;">

            <p:commandButton type="button" value="Sair" id="btnSair" styleClass="ui-button-raised" icon="pi pi-times"
                             onclick="PF('dlgAudio').hide();" style="width: auto;"/>

        </div>

    </p:dialog>


    <p:dialog modal="true" id="dlgBase" widgetVar="dlgBase" draggable="false" resizable="false" closable="false"
              visible="false" width="70%" responsive="true" appendTo="@(body)">

        <div class="col-12">

            <div class="ui-g ui-fluid">

                <h:panelGroup id="pnpVsphone">

                    <audio autoplay="autoplay" controls="controls">

                        <sources src="data:audio/wav;base64,#{supervisorBackofficeBean.base64Dialog}"/>

                    </audio>

                </h:panelGroup>

            </div>

        </div>

    </p:dialog>

</ui:fragment>