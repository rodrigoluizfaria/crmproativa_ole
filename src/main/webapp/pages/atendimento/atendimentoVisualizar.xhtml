<ui:fragment xmlns="http://www.w3.org/1999/xhtml"
             xmlns:h="http://java.sun.com/jsf/html"
             xmlns:f="http://java.sun.com/jsf/core"
             xmlns:of="http://omnifaces.org/functions"
             xmlns:ui="http://java.sun.com/jsf/facelets"
             xmlns:p="http://primefaces.org/ui">

    <p:dialog id="dlgVisualizarAtendimento" widgetVar="dlgVisualizarAtendimento"
              modal="true" draggable="false" resizable="false" closable="true"
              visible="false" width="95%" height="90%" fitViewport="true"
              header="Detalhes do Atendimento" appendTo="@(body)"
              showEffect="fade" hideEffect="fade"
              blockScroll="true" responsive="true">

        <h:form id="formVisualizar" prependId="false">

            <div class="surface-ground p-3">

                <div class="flex justify-content-between align-items-center mb-3">
                    <div class="flex align-items-center gap-2">
                        <span class="text-xl font-bold text-900">Visão Geral</span>
                        <p:tag value="#{meusAtendimentosBean.atendimentoVisualizar.status.descricao}"
                               styleClass="mr-2" severity="info" rounded="true"/>
                    </div>

                    <div class="flex gap-2">
                        <p:commandButton value="Iniciar Novo Atendimento"
                                         icon="pi pi-plus-circle"
                                         disabled="true"
                                         styleClass="ui-button-success ui-button-raised font-bold"
                                         id="novaProposta"
                                         oncomplete="PF('dlgVisualizarAtendimento').hide();">
                            <p:confirm header="Confirmar Ação" message="Deseja iniciar um novo atendimento para este cliente?"
                                       icon="pi pi-question-circle"/>
                        </p:commandButton>

                        <p:commandButton value="Fechar" icon="pi pi-times"
                                         onclick="PF('dlgVisualizarAtendimento').hide();"
                                         process="@this" global="false"
                                         styleClass="ui-button-secondary ui-button-outlined font-bold"/>
                    </div>
                </div>

                <div class="surface-card shadow-2 border-round p-4 mb-4 border-left-3 border-blue-500">
                    <div class="grid ui-fluid">

                        <div class="col-12 md:col-2">
                            <span class="text-500 font-medium text-sm block mb-1">Protocolo</span>
                            <span class="text-900 font-bold text-lg">#{meusAtendimentosBean.atendimentoVisualizar.protocolo}</span>
                        </div>

                        <div class="col-12 md:col-3">
                            <span class="text-500 font-medium text-sm block mb-1">Campanha</span>
                            <div class="flex align-items-center">
                                <i class="pi pi-megaphone text-blue-500 mr-2"></i>
                                <span class="text-900 font-medium">#{meusAtendimentosBean.atendimentoVisualizar.campanha.descricao}</span>
                            </div>
                        </div>

                        <div class="col-12 md:col-3">
                            <span class="text-500 font-medium text-sm block mb-1">Nome do Cliente</span>
                            <div class="flex align-items-center">
                                <i class="pi pi-user text-blue-500 mr-2"></i>
                                <span class="text-900 font-bold">#{meusAtendimentosBean.atendimentoVisualizar.cliente.nome}</span>
                            </div>
                        </div>

                        <div class="col-12 md:col-2">
                            <span class="text-500 font-medium text-sm block mb-1">CPF</span>
                            <span class="text-900 font-medium">#{meusAtendimentosBean.atendimentoVisualizar.cliente.cpf}</span>
                        </div>

                        <div class="col-12 md:col-2">
                            <span class="text-500 font-medium text-sm block mb-1">Idade / Nasc.</span>
                            <span class="text-900">
                                #{meusAtendimentosBean.atendimentoVisualizar.cliente.idade} anos
                                <span class="text-500 mx-1">|</span>
                                <h:outputText value="#{meusAtendimentosBean.atendimentoVisualizar.cliente.dataNascimento}">
                                    <f:convertDateTime pattern="dd/MM/yyyy"/>
                                </h:outputText>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="grid mb-4">

                    <div class="col-12 md:col-8">
                        <div class="surface-card shadow-2 border-round p-0 h-full">
                            <div class="p-3 border-bottom-1 border-100 bg-gray-50 border-round-top">
                                <span class="font-bold text-900"><i class="pi pi-history mr-2 text-blue-600"></i>Histórico do Atendimento</span>
                            </div>

                            <p:dataTable id="tableHistorico"
                                         value="#{meusAtendimentosBean.atendimentoVisualizar.listaHistoricos}"
                                         var="historico" rows="5" paginator="true" paginatorPosition="bottom"
                                         styleClass="ui-datatable-sm border-none" stripedRows="true" reflow="true"
                                         emptyMessage="#{msg.emptyMessage}">

                                <p:column headerText="Data" width="130">
                                    <h:outputText value="#{historico.dataCadastro}">
                                        <f:convertDateTime pattern="dd/MM/yyyy HH:mm"/>
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Status">
                                    <span class="font-bold text-700">#{historico.statusAtendimento.descricao}</span>
                                </p:column>

                                <p:column headerText="Motivo / Detalhe">
                                    <div class="flex flex-column">
                                        <span class="font-medium">#{historico.motivo.descricao}</span>
                                        <span class="text-sm text-500">#{historico.subMotivo.descricao}</span>
                                    </div>
                                </p:column>

                                <p:column headerText="Usuário">
                                    #{historico.usuario.nome}
                                </p:column>

                                <p:column headerText="Obs" width="25%">
                                    <span class="text-sm" title="#{historico.observacao}">
                                        #{of:abbreviate(historico.observacao, 50)}
                                    </span>
                                </p:column>
                            </p:dataTable>
                        </div>
                    </div>

                    <div class="col-12 md:col-4">
                        <div class="surface-card shadow-2 border-round p-0 h-full">
                            <div class="p-3 border-bottom-1 border-100 bg-gray-50 border-round-top">
                                <span class="font-bold text-900"><i class="pi pi-phone mr-2 text-blue-600"></i>Telefones</span>
                            </div>

                            <p:dataTable value="#{meusAtendimentosBean.atendimentoVisualizar.cliente.listaTelefonesOrdenada}"
                                         var="tel" rows="5" paginator="true" paginatorPosition="bottom"
                                         styleClass="ui-datatable-sm border-none" stripedRows="true"
                                         emptyMessage="#{msg.emptyMessage}">

                                <p:column headerText="Número">
                                    <span class="font-bold text-lg">(#{tel.ddd}) #{tel.numero}</span>
                                </p:column>

                                <p:column headerText="Status" styleClass="text-center">
                                    <p:tag value="#{tel.statusTelefone.descricao}"
                                           severity="#{tel.statusTelefone.descricao eq 'Ativo' ? 'success' : 'warning'}"
                                           rounded="true"/>
                                </p:column>

                            </p:dataTable>
                        </div>
                    </div>
                </div>

                <div class="surface-card shadow-2 border-round p-0">

                    <p:tabView id="tabviewVisualizarAtn" styleClass="border-none">

                        <p:tab title="Informações Gerais">
                            <f:facet name="title"><i class="pi pi-info-circle mr-2" />Geral</f:facet>

                            <div class="p-3">
                                <div class="grid">
                                    <div class="col-12">
                                        <span class="text-gray-500 text-sm font-bold uppercase block mb-3">Detalhes do Tratamento</span>

                                        <h:panelGroup rendered="#{meusAtendimentosBean.atendimentoVisualizar.enviarN2}">
                                            <div class="bg-blue-50 border-blue-200 border-1 p-3 border-round mb-3">
                                                <div class="flex align-items-center mb-3 pb-2 border-bottom-1 border-blue-100">
                                                    <i class="pi pi-arrow-circle-right text-blue-600 mr-2 text-xl"></i>
                                                    <span class="font-bold text-blue-900 text-lg">Derivado para N2</span>
                                                </div>

                                                <div class="grid text-sm">
                                                    <div class="col-12 md:col-6">
                                                        <span class="block text-gray-500 mb-1">Responsável:</span>
                                                        <span class="font-medium text-900 text-lg">#{meusAtendimentosBean.atendimentoVisualizar.responsavelN2.nome}</span>
                                                    </div>
                                                    <div class="col-12 md:col-6">
                                                        <span class="block text-gray-500 mb-1">Prazo Limite:</span>
                                                        <span class="font-medium text-900 text-lg">#{meusAtendimentosBean.atendimentoVisualizar.dataPrazoDemandaFormatada}</span>
                                                    </div>

                                                    <div class="col-12 mt-3">
                                                        <span class="block text-gray-500 mb-1 font-bold">Resposta N2:</span>
                                                        <div class="bg-white p-3 border-round border-1 border-200 shadow-1">
                                                            <h:outputText value="#{meusAtendimentosBean.atendimentoVisualizar.respostaN2}" escape="false"/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </h:panelGroup>

                                        <h:panelGroup rendered="#{not meusAtendimentosBean.atendimentoVisualizar.enviarN2}">

                                            <div class="bg-gray-50 border-gray-200 border-1 p-3 border-round mb-3">
                                                <div class="flex align-items-center mb-3 pb-2 border-bottom-1 border-gray-200">
                                                    <i class="pi pi-check-circle text-gray-600 mr-2 text-xl"></i>
                                                    <span class="font-bold text-gray-800 text-lg">
                                                        #{meusAtendimentosBean.atendimentoVisualizar.status.descricao}
                                                    </span>
                                                </div>

                                                <div class="grid text-sm">
                                                    <h:panelGroup layout="block" styleClass="col-12"
                                                                  rendered="#{not empty meusAtendimentosBean.atendimentoVisualizar.observacaoAdicional}">
                                                        <span class="block text-gray-500 mb-1 font-bold">Classificação / Detalhe:</span>
                                                        <div class="bg-white p-2 border-round border-1 border-200 text-700">
                                                            #{meusAtendimentosBean.atendimentoVisualizar.observacaoAdicional}
                                                        </div>
                                                    </h:panelGroup>

                                                    <div class="col-12 mt-2">
                                                        <span class="block text-gray-500 mb-1 font-bold">Observação Final:</span>
                                                        <div class="bg-white p-3 border-round border-1 border-200 shadow-1 text-800 line-height-3">
                                                            <h:outputText value="#{meusAtendimentosBean.atendimentoVisualizar.observacao}"
                                                                          rendered="#{not empty meusAtendimentosBean.atendimentoVisualizar.observacao}"/>
                                                            <h:outputText value="Sem observações registradas."
                                                                          rendered="#{empty meusAtendimentosBean.atendimentoVisualizar.observacao}"
                                                                          styleClass="text-500 font-italic"/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </h:panelGroup>

                                    </div>
                                </div>
                            </div>
                        </p:tab>

                        <p:tab title="Endereços">
                            <f:facet name="title"><i class="pi pi-map-marker mr-2"></i>Endereços</f:facet>
                            <p:dataTable value="#{meusAtendimentosBean.atendimentoVisualizar.cliente.listEnderecos}" var="endereco"
                                         rows="5" paginator="true" paginatorPosition="bottom"
                                         styleClass="ui-datatable-sm" stripedRows="true" showGridlines="true">
                                <p:column headerText="Logradouro">#{endereco.logradouro}, #{endereco.numero}</p:column>
                                <p:column headerText="Bairro">#{endereco.bairro}</p:column>
                                <p:column headerText="Cidade/UF">#{endereco.cidade} - #{endereco.uf}</p:column>
                                <p:column headerText="CEP">#{endereco.cep}</p:column>
                            </p:dataTable>
                        </p:tab>

                        <p:tab title="Dados Bancários">
                            <f:facet name="title"><i class="pi pi-wallet mr-2"></i>Bancário</f:facet>
                            <p:dataTable value="#{meusAtendimentosBean.atendimentoVisualizar.cliente.listDadosBancarios}" var="banco"
                                         rows="5" paginator="true" paginatorPosition="bottom"
                                         styleClass="ui-datatable-sm" stripedRows="true" showGridlines="true">
                                <p:column headerText="Banco">#{banco.banco.constante}</p:column>
                                <p:column headerText="Tipo">#{banco.tipoConta.descricao}</p:column>
                                <p:column headerText="Agência/Conta">
                                    Ag: <b>#{banco.agencia}-#{banco.digitoAgencia}</b> / Cc: <b>#{banco.conta}-#{banco.digitoConta}</b>
                                </p:column>
                            </p:dataTable>
                        </p:tab>

                        <p:tab title="Log de Atividades">
                            <f:facet name="title"><i class="pi pi-list mr-2"></i>Logs</f:facet>
                            <p:dataTable value="#{meusAtendimentosBean.atendimentoVisualizar.listHistoricoAtividades}" var="at"
                                         rows="10" paginator="true" paginatorPosition="bottom" styleClass="ui-datatable-sm" stripedRows="true">
                                <p:column headerText="Data" width="140" styleClass="text-center">
                                    <h:outputText value="#{at.data}"><f:convertDateTime pattern="dd/MM/yyyy HH:mm"/></h:outputText>
                                </p:column>
                                <p:column headerText="Usuário">#{at.usuario.nome}</p:column>
                                <p:column headerText="Evento">
                                    <div class="flex align-items-center">
                                        <i class="#{at.tipoIcone} mr-2 text-blue-500"></i>
                                        #{at.tipoStatusAtividade.descricao}
                                    </div>
                                </p:column>
                                <p:column headerText="Detalhes">#{at.descricao}</p:column>
                            </p:dataTable>
                        </p:tab>

                    </p:tabView>
                </div>

            </div>

            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
                <p:commandButton value="Sim" styleClass="ui-confirmdialog-yes ui-button-primary" type="button" />
                <p:commandButton value="Não" styleClass="ui-confirmdialog-no ui-button-flat ui-button-secondary" type="button" />
            </p:confirmDialog>

        </h:form>

    </p:dialog>

</ui:fragment>