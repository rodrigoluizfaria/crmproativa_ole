<ui:fragment xmlns="http://www.w3.org/1999/xhtml"
             xmlns:h="http://java.sun.com/jsf/html"
             xmlns:f="http://java.sun.com/jsf/core"
             xmlns:of="http://omnifaces.org/functions"
             xmlns:ui="http://java.sun.com/jsf/facelets"
             xmlns:p="http://primefaces.org/ui">

    <p:dialog id="dlgVisualizarAtendimento" widgetVar="dlgVisualizarAtendimento"
              modal="true" draggable="false" resizable="false" closable="true"
              visible="false" width="1100" height="90%" fitViewport="true"
              header="Detalhes do Atendimento" appendTo="@(body)"
              showEffect="fade" hideEffect="fade"
              blockScroll="true" responsive="true"
              styleClass="border-round-xl overflow-hidden">

        <h:form id="formVisualizar" prependId="false" styleClass="h-full flex flex-column">

            <div class="surface-0 border-bottom-1 border-200 p-4 flex flex-column md:flex-row justify-content-between align-items-start md:align-items-center gap-3 flex-shrink-0">

                <div class="flex align-items-center">
                    <div class="bg-blue-50 text-blue-600 border-circle w-4rem h-4rem flex align-items-center justify-content-center mr-3 shadow-1">
                        <i class="pi pi-user text-2xl"></i>
                    </div>
                    <div>
                        <div class="flex align-items-center gap-2 mb-1">
                            <span class="text-2xl font-bold text-900">
                                #{empty meusAtendimentosBean.atendimentoVisualizar.cliente ? 'Cliente Não Identificado' : meusAtendimentosBean.atendimentoVisualizar.cliente.nome}
                            </span>
                            <p:tag value="#{meusAtendimentosBean.atendimentoVisualizar.status.descricao}"
                                   styleClass="#{meusAtendimentosBean.atendimentoVisualizar.status.acao.styleClass}"
                                   rounded="true"/>
                        </div>
                        <div class="flex align-items-center text-600 gap-3 text-sm flex-wrap">
                            <h:panelGroup rendered="#{not empty meusAtendimentosBean.atendimentoVisualizar.cliente}">
                                <span class="flex align-items-center"><i class="pi pi-id-card mr-1"></i>#{meusAtendimentosBean.onOcultarCpf(meusAtendimentosBean.atendimentoVisualizar.cliente.cpf)}</span>
                                <span class="text-300">|</span>
                            </h:panelGroup>

                            <span class="flex align-items-center font-bold text-900"><i class="pi pi-hashtag mr-1 text-primary"></i>#{meusAtendimentosBean.atendimentoVisualizar.protocolo}</span>
                            <span class="text-300">|</span>
                            <span class="flex align-items-center"><i class="pi pi-megaphone mr-1"></i>#{meusAtendimentosBean.atendimentoVisualizar.campanha.descricao}</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2">
                    <p:commandButton value="Novo Atendimento"
                                     icon="pi pi-plus" disabled="true"
                                     process="@this"
                                     action="#{meusAtendimentosBean.gerarNovaProposta()}"
                                     styleClass="ui-button-success font-bold border-round-md shadow-none"
                                     id="novaProposta"
                                     oncomplete="PF('dlgVisualizarAtendimento').hide();">
                        <p:confirm header="Confirmar" message="Deseja iniciar um novo atendimento para este perfil?" icon="pi pi-question-circle"/>
                    </p:commandButton>

                    <p:commandButton value="Fechar" icon="pi pi-times"
                                     onclick="PF('dlgVisualizarAtendimento').hide();"
                                     process="@this" global="false"
                                     styleClass="ui-button-secondary ui-button-outlined border-round-md font-bold"/>
                </div>
            </div>

            <div class="grid m-0 flex-grow-1 overflow-hidden" style="background-color: #f8fafc;">

                <div class="col-12 md:col-8 p-4 overflow-y-auto custom-scroll" style="height: 100%;">

                    <div class="surface-card border-round-xl shadow-1 p-0 overflow-hidden mb-4">
                        <p:tabView id="tabviewVisualizarAtn" styleClass="border-none clean-tabs">

                            <p:tab title="Resumo">
                                <div class="p-4">
                                    <h:panelGroup rendered="#{meusAtendimentosBean.atendimentoVisualizar.enviarN2}" layout="block" styleClass="mb-4">
                                        <div class="bg-blue-50 border-round-lg p-3 border-left-3 border-blue-500">
                                            <div class="flex align-items-center justify-content-between mb-2">
                                                <span class="text-blue-800 font-bold flex align-items-center"><i class="pi pi-directions mr-2"></i>Tratativa Nível 2</span>
                                                <span class="text-xs text-blue-600 font-medium bg-blue-100 px-2 py-1 border-round">Prazo: #{meusAtendimentosBean.atendimentoVisualizar.dataPrazoDemandaFormatada}</span>
                                            </div>
                                            <div class="surface-0 p-3 border-round text-blue-900 line-height-3 text-sm shadow-sm">
                                                <h:outputText value="#{meusAtendimentosBean.atendimentoVisualizar.respostaN2}" escape="false"/>
                                            </div>
                                            <div class="mt-2 text-right">
                                                <span class="text-xs text-blue-500">Responsável: <b>#{meusAtendimentosBean.atendimentoVisualizar.responsavelN2.nome}</b></span>
                                            </div>
                                        </div>
                                    </h:panelGroup>

                                    <h:panelGroup rendered="#{not meusAtendimentosBean.atendimentoVisualizar.enviarN2}">
                                        <div class="mb-3">
                                            <span class="text-xs font-bold text-500 uppercase block mb-2">Relato do Atendimento</span>
                                            <div class="text-900 line-height-3 text-lg bg-gray-50 p-3 border-round-lg border-1 border-100">
                                                <h:outputText value="#{meusAtendimentosBean.atendimentoVisualizar.observacao}"
                                                              rendered="#{not empty meusAtendimentosBean.atendimentoVisualizar.observacao}"/>
                                                <h:outputText value="Sem observações registradas."
                                                              rendered="#{empty meusAtendimentosBean.atendimentoVisualizar.observacao}"
                                                              styleClass="text-500 font-italic"/>
                                            </div>
                                        </div>

                                        <h:panelGroup rendered="#{not empty meusAtendimentosBean.atendimentoVisualizar.observacaoN2}">
                                            <div class="mb-3">
                                                <span class="text-xs font-bold text-500 uppercase block mb-2">Detalhe Técnico / Classificação</span>
                                                <div class="text-700 bg-white border-1 border-200 p-2 border-round">
                                                    #{meusAtendimentosBean.atendimentoVisualizar.observacaoN2}
                                                </div>
                                            </div>
                                        </h:panelGroup>
                                    </h:panelGroup>
                                </div>
                            </p:tab>

                            <p:tab title="Contatos">
                                <h:panelGroup styleClass="p-0 block" rendered="#{not empty meusAtendimentosBean.atendimentoVisualizar.cliente}">
                                    <p:dataTable value="#{meusAtendimentosBean.atendimentoVisualizar.cliente.listaTelefonesOrdenada}"
                                                 var="tel" styleClass="ui-datatable-borderless" rowStyleClass="border-bottom-1 border-100">
                                        <p:column headerText="Número">
                                            <span class="font-medium text-lg text-900">(#{tel.ddd}) #{tel.numero}</span>
                                        </p:column>
                                        <p:column headerText="Tipo" width="100">
                                            <span class="text-600 text-sm bg-gray-100 px-2 py-1 border-round">Móvel</span>
                                        </p:column>
                                        <p:column headerText="Status" width="100" styleClass="text-right">
                                            <i class="pi pi-circle-fill text-xs #{tel.statusTelefone.descricao eq 'Ativo' ? 'text-green-500' : 'text-red-500'} mr-1"></i>
                                            <span class="text-sm">#{tel.statusTelefone.descricao}</span>
                                        </p:column>
                                    </p:dataTable>
                                </h:panelGroup>
                                <h:outputText value="Cliente não identificado." rendered="#{empty meusAtendimentosBean.atendimentoVisualizar.cliente}" styleClass="p-4 block text-500"/>
                            </p:tab>

                            <p:tab title="Endereços">
                                <h:panelGroup styleClass="p-0 block" rendered="#{not empty meusAtendimentosBean.atendimentoVisualizar.cliente}">
                                    <p:dataTable value="#{meusAtendimentosBean.atendimentoVisualizar.cliente.listEnderecos}" var="endereco"
                                                 styleClass="ui-datatable-borderless text-sm" rowStyleClass="border-bottom-1 border-100">
                                        <p:column headerText="Endereço">
                                            <div class="flex flex-column">
                                                <span class="font-bold text-900">#{endereco.logradouro}, #{endereco.numero}</span>
                                                <span class="text-500">#{endereco.bairro} - #{endereco.cep}</span>
                                            </div>
                                        </p:column>
                                        <p:column headerText="Cidade" width="150">
                                            #{endereco.cidade} / #{endereco.uf}
                                        </p:column>
                                    </p:dataTable>
                                </h:panelGroup>
                                <h:outputText value="Cliente não identificado." rendered="#{empty meusAtendimentosBean.atendimentoVisualizar.cliente}" styleClass="p-4 block text-500"/>
                            </p:tab>

                            <p:tab title="Logs do Sistema">
                                <div class="p-0">
                                    <p:dataTable value="#{meusAtendimentosBean.atendimentoVisualizar.listHistoricoAtividades}" var="at"
                                                 rows="5" paginator="true" paginatorPosition="bottom" styleClass="ui-datatable-sm ui-datatable-borderless" stripedRows="true">
                                        <p:column headerText="Data" width="130">
                                            <span class="text-sm font-medium"><h:outputText value="#{at.data}"><f:convertDateTime pattern="dd/MM HH:mm"/></h:outputText></span>
                                        </p:column>
                                        <p:column headerText="Evento">
                                            <span class="text-sm">#{at.tipoStatusAtividade.descricao}</span>
                                        </p:column>
                                    </p:dataTable>
                                </div>
                            </p:tab>
                        </p:tabView>
                    </div>
                </div>

                <div class="col-12 md:col-4 p-4 pl-0 h-full overflow-hidden">

                    <div class="surface-card border-round-xl shadow-1 h-full flex flex-column">
                        <div class="p-3 border-bottom-1 border-100 flex align-items-center bg-gray-50 border-round-top-xl flex-shrink-0">
                            <i class="pi pi-history text-gray-500 mr-2"></i>
                            <span class="font-bold text-700">Linha do Tempo</span>
                        </div>

                        <div class="flex-grow-1 overflow-y-auto custom-scroll p-3">
                            <ui:repeat value="#{meusAtendimentosBean.atendimentoVisualizar.listaHistoricos}" var="hist" varStatus="status">
                                <div class="flex mb-0 relative">
                                    <div class="flex flex-column align-items-center mr-3" style="min-width: 20px;">
                                        <div class="w-1rem h-1rem border-circle bg-blue-100 border-2 border-blue-500 z-1 flex-shrink-0"></div>
                                        <h:panelGroup rendered="#{!status.last}" styleClass="w-2px bg-gray-300 flex-grow-1 -mt-1" layout="block" style="min-height: 2rem;"/>
                                    </div>

                                    <div class="pb-4 w-full">
                                        <div class="flex justify-content-between align-items-baseline mb-1">
                                            <span class="font-bold text-900 text-sm">#{hist.statusAtendimento.descricao}</span>
                                            <span class="text-xs text-500 bg-gray-100 px-2 border-round">
                                                <h:outputText value="#{hist.dataCadastro}"><f:convertDateTime pattern="dd/MM HH:mm"/></h:outputText>
                                            </span>
                                        </div>

                                        <div class="text-sm text-700 mb-1 font-medium">
                                            #{hist.motivo.descricao}
                                        </div>

                                        <div class="text-xs text-500 flex align-items-center mb-2">
                                            <i class="pi pi-user mr-1 text-xs"></i> #{hist.usuario.nome}
                                        </div>

                                        <h:panelGroup rendered="#{not empty hist.observacao}">
                                            <div class="surface-100 p-2 border-round text-xs text-600 font-italic line-height-3 border-1 border-100 relative">
                                                <i class="pi pi-comment absolute text-gray-300" style="right: 5px; top: 5px;"></i>
                                                "#{of:abbreviate(hist.observacao, 80)}"
                                            </div>
                                        </h:panelGroup>
                                    </div>
                                </div>
                            </ui:repeat>

                            <h:panelGroup rendered="#{empty meusAtendimentosBean.atendimentoVisualizar.listaHistoricos}">
                                <div class="text-center py-4">
                                    <span class="text-500 text-sm">Nenhum histórico registrado.</span>
                                </div>
                            </h:panelGroup>
                        </div>
                    </div>

                </div>

            </div>

            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
                <p:commandButton value="Sim" styleClass="ui-confirmdialog-yes ui-button-primary" type="button" />
                <p:commandButton value="Não" styleClass="ui-confirmdialog-no ui-button-flat ui-button-secondary" type="button" />
            </p:confirmDialog>

        </h:form>

        <style>
            /* Custom Scrollbar for a cleaner look */
            .custom-scroll::-webkit-scrollbar { width: 6px; }
            .custom-scroll::-webkit-scrollbar-track { background: transparent; }
            .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
            .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

            /* Remove tabview borders */
            body .clean-tabs .ui-tabs-nav { background: transparent; border: none; border-bottom: 1px solid #e5e7eb; }
            body .clean-tabs .ui-tabs-panel { padding: 0 !important; }

            /* Ajuste para tags dentro do header */
            .ui-tag { font-weight: 700; letter-spacing: 0.5px; }
        </style>

    </p:dialog>

</ui:fragment>