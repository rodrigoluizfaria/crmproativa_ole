<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui">

    <h:panelGroup styleClass="card shadow-2 border-round-xl p-3 bg-white" layout="block">

        <h:panelGroup styleClass="flex justify-content-center mb-4 bg-gray-100 border-round-3xl p-1 " layout="block"
                      id="abasHistorico">

            <p:commandButton value="Atividades (#{fichaAtendimentoSacBean.listHistoricoAtividadesDto.size()})"
                             actionListener="#{fichaAtendimentoSacBean.onSetStepModalHistorico(0)}"
                             styleClass="#{fichaAtendimentoSacBean.stepHistorico eq 0 ? 'ui-button-text bg-white text-900 shadow-1': 'ui-button-flat ui-button-secondary text-600'}  flex-1 border-round-2xl"
                             process="@this" partialSubmit="true" update="abasHistorico pnpHistoricoPrincipal"
                             style="font-weight: 600;"/>

            <p:commandButton value="Protocolos (#{fichaAtendimentoSacBean.listHistoricoProtocolosDTO.size()})"
                             process="@this" update="abasHistorico pnpHistoricoPrincipal" partialSubmit="true"
                             actionListener="#{fichaAtendimentoSacBean.onSetStepModalHistorico(1)}"
                             styleClass="#{fichaAtendimentoSacBean.stepHistorico eq 1 ? 'ui-button-text bg-white text-900 shadow-1': 'ui-button-flat ui-button-secondary text-600'}   flex-1 border-round-2xl"
                             style="font-weight: 700; color: #343a40 !important;"/>
        </h:panelGroup>


        <h:panelGroup id="pnpHistoricoPrincipal">

            <h:panelGroup styleClass="overflow-y-auto" id="pnpHistorico"
                          rendered="#{fichaAtendimentoSacBean.stepHistorico eq 1}">

                <div class="mb-3">
                    <h4 class="text-900 m-0 mb-1">Histórico de Protocolos</h4>
                    <span class="text-500 text-sm">Todos os protocolos do cliente</span>
                </div>

                <h:panelGroup styleClass="overflow-y-auto" style="max-height: 500px;" layout="block"
                              rendered="#{not empty fichaAtendimentoSacBean.listHistoricoProtocolosDTO}">

                    <ui:repeat value="#{fichaAtendimentoSacBean.listHistoricoProtocolosDTO}" var="proto">

                        <p:commandLink actionListener="#{fichaAtendimentoSacBean.visualizarAtendimentoProtocolo(proto.idAtendimento)}"
                                       update="dialogDevolutivaContent"
                                       oncomplete="PF('dlgDevolutiva').show()"
                                       process="@this"
                                       styleClass="text-decoration-none block mb-3">

                            <div class="surface-card border-1 border-200 border-round-xl p-3 hover:shadow-2 hover:border-blue-500 transition-all transition-duration-200 cursor-pointer">
                                <div class="flex justify-content-between align-items-center mb-2">
                                    <span class="font-bold text-700 text-lg">#{proto.numeroProtocolo}</span>

                                    <div class="px-2 py-1 border-round border-1 flex align-items-center w-fit #{proto.status.estiloCss}">
                                        <i class="#{proto.status.icone} mr-2 text-xs" />
                                        <span class="text-sm font-bold uppercase">#{proto.status.descricao}</span>
                                    </div>
                                </div>

                                <div class="mb-2">
                    <span class="px-2 py-1 border-round bg-gray-200 text-700 text-sm font-bold">
                        #{proto.tipo}
                    </span>
                                </div>

                                <p class="text-600 text-sm line-height-3 m-0 mb-3 text-left"> #{proto.descricao}
                                </p>

                                <div class="flex justify-content-between align-items-center border-top-1 border-100 pt-2">
                                    <div class="flex flex-column text-left">
                                        <span class="text-500 text-xs">Abertura:</span>
                                        <span class="text-700 font-medium text-sm">
                            <h:outputText value="#{proto.dataAbertura}">
                                <f:convertDateTime pattern="dd/MM/yyyy"/>
                            </h:outputText>
                        </span>
                                    </div>

                                    <div class="flex flex-column align-items-end">
                                        <span class="text-500 text-xs">Prazo:</span>
                                        <span class="font-bold text-sm" style="color: #F59E0B;">
                            <h:outputText value="#{proto.dataPrazo}">
                                <f:convertDateTime pattern="dd/MM/yyyy"/>
                            </h:outputText>
                        </span>
                                    </div>
                                </div>
                            </div>

                        </p:commandLink>

                    </ui:repeat>




                </h:panelGroup>

                <!-- HISTORICO PROTOCOLOS VAZIO-->
                <h:panelGroup layout="block" rendered="#{ empty fichaAtendimentoSacBean.listHistoricoProtocolosDTO}"
                              styleClass="col-12">

                    <div class="flex flex-column align-items-center justify-content-center p-5 bg-white border-round-xl border-1 border-200 shadow-1 h-full">

                        <div class="w-5rem h-5rem border-circle bg-bluegray-50 flex align-items-center justify-content-center mb-3">
                            <i class="pi pi-credit-card text-bluegray-400 text-4xl"></i>
                            <i class="pi pi-ban text-pink-500 text-xl absolute mb-4 ml-4 bg-white border-circle p-1"></i>
                        </div>

                        <span class="text-900 font-bold text-xl mb-2">Nenhum Atendimento encontrado</span>
                        <p class="text-600 m-0 text-center line-height-3"
                           style="max-width: 300px">
                            Não identificamos protocolos vinculados a este cliente no momento.
                        </p>

                        <div class="mt-4">
                            <p:commandButton value="Atualizar" process="@this" update="@form"
                                             icon="pi pi-refresh"
                                             styleClass="ui-button-outlined ui-button-secondary border-round-lg"/>
                        </div>
                    </div>

                </h:panelGroup>

            </h:panelGroup>

            <h:panelGroup styleClass="overflow-y-auto" id="pnpAtividade"
                          rendered="#{fichaAtendimentoSacBean.stepHistorico eq 0}">

                <div class="mb-3">
                    <h4 class="text-900 m-0 mb-1">Histórico de Atividades</h4>
                    <span class="text-500 text-sm">Linha do tempo do atendimento</span>
                </div>

                <h:panelGroup layout="block" rendered="#{not empty fichaAtendimentoSacBean.listHistoricoAtividadesDto}"
                              styleClass="col-12">

                    <div class="flex flex-column">

                        <ui:repeat value="#{fichaAtendimentoSacBean.listHistoricoAtividadesDto}" var="atv"
                                   varStatus="status">

                            <div class="flex">
                                <div class="flex flex-column align-items-center mr-3 relative" style="width: 40px;">

                                    <div class="absolute bg-gray-300"
                                         style="width: 2px; top: 0; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 0; display: #{status.last ? 'none' : 'block'}"></div>

                                    <div class="flex align-items-center justify-content-center border-circle z-1 shadow-1
                                #{atv.autor eq 'Sistema' ? 'bg-blue-50 text-blue-500' : 'bg-blue-100 text-primary'}"
                                         style="width: 2.5rem; height: 2.5rem; background-color: #fff;">
                                        <i class="pi #{atv.tipoIcone} text-lg"></i>
                                    </div>
                                </div>

                                <div class="pb-4 w-full">
                                    <div class="surface-card border-1 border-200 border-round p-3 hover:shadow-2 transition-duration-200 relative">

                                        <div class="absolute w-1rem h-1rem surface-card border-left-1 border-bottom-1 border-200"
                                             style="left: -0.5rem; top: 0.75rem; transform: rotate(45deg);"></div>

                                        <span class="text-900 font-bold block mb-1">#{atv.tipoStatusAtividade.descricao}</span>

                                        <h:panelGroup rendered="#{not empty atv.detalhes}">
                                            <span class="text-700 font-medium text-sm block mb-1">#{atv.detalhes}</span>
                                        </h:panelGroup>

                                        <h:panelGroup rendered="#{not empty atv.descricao}">
                                            <span class="text-600 text-sm block mb-2">#{atv.descricao}</span>
                                        </h:panelGroup>

                                        <div class="flex align-items-center text-xs text-500 mt-2 pt-2 border-top-1 border-100">
                                            <i class="pi pi-clock mr-1"></i>
                                            <h:outputText value="#{atv.data}">
                                                <f:convertDateTime pattern="dd/MM, HH:mm"/>
                                            </h:outputText>
                                            <span class="mx-2">•</span>
                                            <span class="font-bold #{atv.autor eq 'Sistema' ? 'text-500' : 'text-blue-600'}">#{atv.autor}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </ui:repeat>
                    </div>


                </h:panelGroup>

                <!-- HISTORICO ATIVIDADE VAZIO-->
                <h:panelGroup layout="block" rendered="#{ empty fichaAtendimentoSacBean.listHistoricoAtividadesDto}"
                              styleClass="col-12">

                    <div class="flex flex-column align-items-center justify-content-center p-5 bg-white border-round-xl border-1 border-200 shadow-1 h-full">

                        <div class="w-5rem h-5rem border-circle bg-bluegray-50 flex align-items-center justify-content-center mb-3">
                            <i class="pi pi-history text-bluegray-400 text-4xl"></i>
                            <i class="pi pi-ban text-pink-500 text-xl absolute mb-4 ml-4 bg-white border-circle p-1"></i>
                        </div>


                        <p class="text-600 m-0 text-center line-height-3"
                           style="max-width: 300px">
                            Não há atividades.
                        </p>

                        <div class="mt-4">
                            <p:commandButton value="Atualizar" process="@this"
                                             icon="pi pi-refresh"
                                             styleClass="ui-button-outlined ui-button-secondary border-round-lg"/>
                        </div>
                    </div>

                </h:panelGroup>

            </h:panelGroup>

        </h:panelGroup>

    </h:panelGroup>
    <p:dialog header="Detalhes do Atendimento"
              widgetVar="dlgDevolutiva"
              modal="true"
              responsive="true"
              width="650"
              showEffect="fade"
              hideEffect="fade"
              blockScroll="true"
              fitViewport="true">

        <h:panelGroup id="dialogDevolutivaContent" layout="block">

            <h:panelGroup rendered="#{not empty fichaAtendimentoSacBean.atendimentoVisualizar}"
                          styleClass="flex flex-column p-2">

                <div class="surface-0 mb-4 border-1 border-200 border-round-xl p-3 flex align-items-center shadow-1">

                    <div class="border-circle bg-blue-100 flex align-items-center justify-content-center mr-3"
                         style="width: 3.5rem; height: 3.5rem; min-width: 3.5rem;">
                        <span class="text-xl font-bold text-blue-600 uppercase">
                            #{fn:substring(fichaAtendimentoSacBean.atendimentoVisualizar.cliente.nome, 0, 1)}
                        </span>
                    </div>

                    <div class="flex flex-column">
                        <span class="text-sm text-500 mb-1">Cliente</span>

                        <span class="text-900 font-bold text-lg">
                            #{fichaAtendimentoSacBean.atendimentoVisualizar.cliente.nome}
                        </span>

                        <h:panelGroup rendered="#{not empty fichaAtendimentoSacBean.atendimentoVisualizar.cliente.cpf}">
                            <div class="flex align-items-center mt-1">
                                <i class="pi pi-id-card text-500 mr-2 text-sm"></i>
                                <span class="text-600 font-medium text-sm">
                                    CPF: #{fichaAtendimentoSacBean.atendimentoVisualizar.cliente.cpf}
                                </span>
                            </div>
                        </h:panelGroup>
                    </div>
                </div>

                <div class="flex justify-content-between align-items-center mb-3 px-1">
                    <div class="flex flex-column">
                        <span class="text-500 text-xs font-bold uppercase mb-1">Protocolo</span>
                        <span class="text-700 text-2xl font-bold">#{fichaAtendimentoSacBean.atendimentoVisualizar.protocolo}</span>
                    </div>

                    <div class="flex align-items-center">
                        <h:panelGroup rendered="#{not empty fichaAtendimentoSacBean.atendimentoVisualizar.status}">
                            <p:tag value="#{fichaAtendimentoSacBean.atendimentoVisualizar.status.descricao}"
                                   icon="#{fichaAtendimentoSacBean.atendimentoVisualizar.status.acao.icone}"
                                   styleClass="#{fichaAtendimentoSacBean.atendimentoVisualizar.status.acao.styleClass} px-3 py-2 text-base"
                                   rounded="true"/>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{empty fichaAtendimentoSacBean.atendimentoVisualizar.status}">
                            <p:tag value="Sem Status" icon="pi pi-info-circle" styleClass="surface-200 text-600 px-3" rounded="true"/>
                        </h:panelGroup>
                    </div>
                </div>

                <div class="flex align-items-center text-700 mb-4 bg-bluegray-50 p-2 border-round border-1 border-100">
                    <i class="pi pi-folder-open mr-2 text-primary"></i>
                    <span class="font-bold text-sm">#{fichaAtendimentoSacBean.atendimentoVisualizar.motivo.descricao}</span>

                    <i class="pi pi-chevron-right mx-2 text-400 text-xs"></i>

                    <span class="text-sm">#{fichaAtendimentoSacBean.atendimentoVisualizar.subMotivo.descricao}</span>
                </div>

                <p:divider styleClass="my-3"/>

                <div class="field mb-4">
                    <label class="font-bold block text-900 mb-2 flex align-items-center">
                        <i class="pi pi-align-left mr-2 text-blue-500" />Relato do Cliente
                    </label>
                    <div class="surface-100 p-3 border-round border-1 border-200">
                        <h:outputText value="#{fichaAtendimentoSacBean.atendimentoVisualizar.observacao}"
                                      style="white-space: pre-wrap; line-height: 1.6;"
                                      rendered="#{not empty fichaAtendimentoSacBean.atendimentoVisualizar.observacao}"/>

                        <h:outputText value="Sem descrição informada."
                                      rendered="#{empty fichaAtendimentoSacBean.atendimentoVisualizar.observacao}"
                                      styleClass="text-500 font-italic"/>
                    </div>
                </div>

                <div class="field">
                    <label class="font-bold block text-900 mb-2 flex align-items-center">
                        <i class="pi pi-check-circle mr-2 text-green-500" />Devolutiva / Resposta
                    </label>

                    <div class="surface-0 p-3 border-round border-1 border-300 shadow-1 bg-white">
                        <h:panelGroup rendered="#{not empty fichaAtendimentoSacBean.atendimentoVisualizar.respostaN2}">
                            <div class="line-height-3 text-800">
                                <h:outputText value="#{fichaAtendimentoSacBean.atendimentoVisualizar.respostaN2}"
                                              escape="false"/>
                            </div>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{empty fichaAtendimentoSacBean.atendimentoVisualizar.respostaN2}"
                                      styleClass="flex align-items-center text-500 font-italic">
                            <i class="pi pi-hourglass mr-2"></i>
                            <span>Ainda não há devolutiva registrada para este protocolo.</span>
                        </h:panelGroup>
                    </div>
                </div>

            </h:panelGroup>
        </h:panelGroup>

        <f:facet name="footer">

            <div class="flex justify-content-end pt-2">
                <p:commandButton value="Fechar" icon="pi pi-times" type="button"
                                 onclick="PF('dlgDevolutiva').hide();"
                                 styleClass="ui-button-secondary ui-button-flat font-bold"/>
            </div>
        </f:facet>
    </p:dialog>

</ui:composition>